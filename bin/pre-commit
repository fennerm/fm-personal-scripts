#!/usr/bin/env python
"""Git pre-commit hook for a python package.

Generate requirements.txt with pipreqs
"""
from plumbum import (
    local,
    FG,
)
from plumbum.cmd import (
    git,
    pipreqs,
)


def run_pipreqs():
    """Generate requirements.txt files with pipreqs."""
    pipreqs['--force', '--savepath', 'dev-requirements.txt', local.cwd] & FG
    pipreqs['--force', '--ignore', 'test', local.cwd] & FG


def decrease_version_strictness(requirements_file):
    """Loosen the version requirements generated by pipreqs."""
    with requirements_file.open('r') as f:
        requirements = f.read().split("\n")

    new_requirements = []
    for requirement in requirements:
        if requirement:
            name = requirement.split("==")[0]
            version = requirement.split("==")[1]
            if version != 'info' and name != 'setuptools':
                major_version = int(version.split('.')[0])

                next_major_version = str(major_version + 1) + ".0.0"
                new_requirements.append(''.join([name, ">=", version, ",<",
                                                 next_major_version]))

    new_requirements = '\n'.join(new_requirements)

    with requirements_file.open('w') as f:
        f.writelines(new_requirements)


def main():
    run_pipreqs()
    requirements_file = local.path('requirements.txt')
    dev_requirements_file = local.path('dev-requirements.txt')
    decrease_version_strictness(requirements_file)
    decrease_version_strictness(dev_requirements_file)
    git('add', 'requirements.txt')
    git('add', 'dev-requirements.txt')


if __name__ == "__main__":
    main()
