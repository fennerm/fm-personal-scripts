#!/usr/bin/env python
"""Git pre-commit hook for a python package: 

Generate requirements.txt with pipreqs
"""
from plumbum import (
    local,
    FG,
)
from plumbum.cmd import (
    git,
    pipreqs,
)


def run_pipreqs():
    """Generate a requirements.txt file with pipreqs"""
    pipreqs["--force", "--ignore", "test", local.cwd] & FG


def decrease_version_strictness():
    """Loosen the version requirements generated by pipreqs"""
    requirements_file = local.path('requirements.txt')

    with requirements_file.open('r') as f:
        requirements = f.read().split("\n")

    new_requirements = []
    for requirement in requirements:
        if requirement:
            name = requirement.split("==")[0]
            version = requirement.split("==")[1]
            if version != 'info':
                next_major_version = str(int(version[0]) + 1) + ".0.0"
                new_requirements.append(''.join([name, ">=", version, ",<",
                                                 next_major_version]))

    new_requirements = '\n'.join(new_requirements)

    with requirements_file.open('w') as f:
        f.writelines(new_requirements)


def main():
    run_pipreqs()
    decrease_version_strictness()
    git('add', 'requirements.txt')


if __name__ == "__main__":
    main()
